<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

{%- comment -%}
Content Security Policy
{%- endcomment -%}
{% assign github_username = site.link.github | split: "/" | last %}
{% if jekyll.environment == "development" %}
  {% assign localhost_host = site.host | default: "localhost" %}
  {% assign localhost_port = site.port | default: "4000" %}
  {% assign localhost_src = "http://localhost:" | append: localhost_port | append: " http://127.0.0.1:" | append: localhost_port %}
{% else %}
  {% assign localhost_src = "" %}
{% endif %}
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' https://raw.githubusercontent.com/{{ github_username }}
    'sha256-n6q1oxIzEuXvWMMY8S0ZbN3QP1E8lrB54bUGmo8rjes='
    'sha256-YpETO48EPpxKTiDeHFBU23QXi/8Rpqh4jDdARgcDKRg='
    'unsafe-hashes';
  style-src 'self' 'unsafe-inline';
  img-src 'self' {{ localhost_src }} data: https:;
  font-src 'self' data:;
  connect-src 'self' https://raw.githubusercontent.com/{{ github_username }};
  base-uri 'self';
  form-action 'self';
">

{%- comment -%}
Locale
{%- endcomment -%}
{% assign lang_value = page.lang | default: site.lang | default: "en-US" %}
<meta property="og:locale" content="{{ lang_value | replace: '-', '_' }}">

{%- comment -%}
Site Name
{%- endcomment -%}
{% if page.permalink == "/" %}
  {% if page.title %}
<meta property="og:site_name" content="{{ site.heading }} - {{ page.title }}">
  {% else %}
<meta property="og:site_name" content="{{ site.heading }}">
  {% endif %}
{% else %}
<meta property="og:site_name" content="{{ page.title }}">
{% endif %}

{%- comment -%}
Description & Tagline
{%- endcomment -%}
{% if page.description %}
<meta name="description" content="{{ page.description }}">
<meta property="og:description" content="{{ page.description }}">
{% else %}
<meta name="tagline" content="{{ site.content }}">
<meta name="description" content="{{ site.description | strip_html | xml_escape | truncate: 200 }}">
<meta property="og:description" content="{{ site.description | strip_html | xml_escape | truncate: 200 }}">
{% endif %}

{%- comment -%}
Keywords (supports arrays or strings)
{%- endcomment -%}
{% assign kw_page = page.keywords %}
{% assign kw_site = site.keywords %}
{% assign keywords = kw_page | default: kw_site %}

{% if keywords %}
  {% if keywords | join: "" %}
<meta property="keywords" content="{{ keywords | join: ', ' }}">
  {% else %}
<meta property="keywords" content="{{ keywords }}">
  {% endif %}
{% endif %}

{%- comment -%}
Author
{%- endcomment -%}
<meta property="article:author"
      content="{% if page.author %}{{ page.author }}{% elsif site.author %}{{ site.author }}{% else %}{{ site.url }}/about{% endif %}">

{%- comment -%}
Open Graph Image
{%- endcomment -%}
{% assign ogimg_value = page.ogimg | default: site.url | append: site.ogimg %}
<meta property="og:image" content="{{ ogimg_value }}">
<link rel="image_src" href="{{ ogimg_value }}">

{%- comment -%}
Open Graph Title + Type
{%- endcomment -%}
{% if page.title %}
  {% if page.permalink == "/" %}
<meta property="og:title" content="{{ site.heading }} - {{ page.title }}">
  {% else %}
<meta property="og:title" content="{{ page.title }}">
  {% endif %}
<meta property="og:type" content="article">
{% else %}
  {% if page.permalink == "/" %}
<meta property="og:title" content="{{ site.heading }}">
  {% endif %}
<meta property="og:type" content="website">
{% endif %}

{%- comment -%}
URL Canonical
{%- endcomment -%}
<meta property="og:url" content="{{ page.url | absolute_url }}">

{%- comment -%}
Article Published / Modified Dates
{%- endcomment -%}
{% if page.date %}
  {% assign pub_date = page.date | date: "%Y-%m-%d" %}
  {% assign upd_date = pub_date %}

  {% if page.last_modified_at and page.last_modified_at != page.date %}
    {% assign upd_date = page.last_modified_at | date: "%Y-%m-%d" %}
  {% endif %}

<meta property="article:published_time"
      content="{{ page.date | date_offset: site.timezone | date_to_xmlschema }}">

  {% if upd_date != pub_date %}
<meta property="article:modified_time"
      content="{{ page.last_modified_at | date_offset: site.timezone | date_to_xmlschema }}">
  {% endif %}
{% endif %}

{%- comment -%}
Categories & Tags
{%- endcomment -%}
{% for category in page.categories %}
<meta property="article:section" content="{{ category }}">
{% endfor %}

{% for tag in page.tags %}
<meta property="article:tag" content="{{ tag }}">
{% endfor %}

{%- comment -%}
Indexing rules
{%- endcomment -%}
{% if page.noindex == "follow" %}
<meta name="robots" content="noindex">
{% elsif page.noindex == "nofollow" %}
<meta name="robots" content="noindex, nofollow">
{% endif %}

{%- comment -%}
Page Title
{%- endcomment -%}
{% if page.permalink == "/" %}
  {% if page.title %}
<title>{{ site.heading }} - {{ page.title }}</title>
  {% else %}
<title>{{ site.heading }}</title>
  {% endif %}
{% elsif page.title %}
<title>{{ page.title }} - {{ site.heading }}</title>
{% elsif page.permalink == "/404.html" %}
<title>There's been a glitch...</title>
{% endif %}

{%- comment -%}
Canonical or Redirect
{%- endcomment -%}
{% assign redirect_url = page.redirect | default: "" | strip %}

{% if redirect_url != "" %}
  {% unless redirect_url contains "://" %}
    {% assign redirect_url = redirect_url | prepend: site.baseurl | absolute_url %}
  {% endunless %}

<meta http-equiv="refresh" content="0; url={{ redirect_url }}">
<link rel="canonical" href="{{ redirect_url }}">
{% else %}
<link rel="canonical" href="{{ page.url | absolute_url }}">
{% endif %}

{%- comment -%}
Twitter
{%- endcomment -%}
<meta name="twitter:card" content="summary_large_image">

{% if site.twitter %}
<meta name="twitter:site" content="@{{ site.twitter }}">
<meta name="twitter:creator" content="@{{ site.twitter }}">
{% endif %}

{% if page.title %}
  {% if page.permalink == "/" %}
<meta name="twitter:title" content="{{ site.heading }} - {{ page.title }}">
  {% else %}
<meta name="twitter:title" content="{{ page.title }}">
  {% endif %}
{% else %}
<meta name="twitter:title" content="{{ site.heading }}">
{% endif %}

{% assign page_content = page.content | strip_html | xml_escape | truncate: 180 %}

{% if page.description %}
<meta name="twitter:description" content="{{ page.description }}">
{% elsif page_content.size > 50 %}
<meta name="twitter:description" content="{{ page_content }}">
{% else %}
<meta name="twitter:description" content="{{ site.description | strip_html | xml_escape | truncate: 180 }}">
{% endif %}

<meta name="twitter:image"
      content="{% if page.ogimg %}{{ page.ogimg }}{% else %}{{ site.url }}{{ site.ogimg }}{% endif %}">

{%- comment -%}
Mastodon
{%- endcomment -%}
{% if site.link and site.link.mastodon %}
  {% for mastodon_link in site.link.mastodon %}
<link rel="me" href="{{ mastodon_link }}">
  {% endfor %}
{% endif %}
