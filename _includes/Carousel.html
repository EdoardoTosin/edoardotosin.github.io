{%- comment -%}
*
* MIT License
* Copyright (c) 2024 Edoardo Tosin
*
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in all
* copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
* SOFTWARE.
*
* File: Carousel.html
* Edoardo Tosin
* This file contains the markup for a responsive image carousel with indicators
* and automatic sliding functionality.
*
{%- endcomment -%}

{% comment %}
  Carousel Component with PhotoSwipe Integration
  
  Usage:
    {% include Carousel.html 
      id="my-carousel"
      gallery="my-gallery"
    %}
  
  Front Matter Configuration:
    carousels:
      - id: my-carousel
        images:
          - image: /path/to/image1.jpg
            caption: "First image"
            alt: "Alt text"
          - image: /path/to/image2.jpg
            caption: "Second image"
        settings:
          auto_play: true
          duration: 5
  
  Parameters:
    - id (optional): Carousel ID to match front matter
    - number (optional): Legacy numeric index
    - gallery (optional): Gallery ID for PhotoSwipe grouping
    - auto_play (optional): Override auto-play setting
    - duration (optional): Override duration (seconds)
{% endcomment %}

{% comment %} Select carousel data {% endcomment %}
{% if include.id %}
  {% for carousel in page.carousels %}
    {% if carousel.id == include.id %}
      {% assign carousel_data = carousel %}
      {% assign carousel_index = forloop.index0 %}
      {% break %}
    {% endif %}
  {% endfor %}
{% elsif include.number %}
  {% assign carousel_index = include.number | minus: 1 %}
  {% assign carousel_data = page.carousels[carousel_index] %}
{% else %}
  {% assign carousel_index = 0 %}
  {% assign carousel_data = page.carousels[0] %}
{% endif %}

{% comment %} Generate unique IDs {% endcomment %}
{% if include.id %}
  {% assign carousel_id = include.id | slugify %}
{% else %}
  {% assign carousel_id = carousel_index %}
{% endif %}

{% assign gallery_id = include.gallery | default: carousel_id | append: '-gallery' %}

{% comment %} Error handling {% endcomment %}
{% unless carousel_data %}
  <div class="notification is-danger">
    <strong>Carousel Error:</strong> No carousel data found for 
    {% if include.id %}"{{ include.id }}"{% elsif include.number %}number {{ include.number }}{% else %}default carousel{% endif %}.
  </div>
  {% break %}
{% endunless %}

{% comment %} Print-only fallback - show first image only {% endcomment %}
<div class="only-print">
  {% assign first_item = carousel_data.images[0] %}
  {% if first_item %}
    <figure class="image">
      <img src="{{ first_item.image }}" 
           alt="{{ first_item.alt | default: first_item.caption | markdownify | strip_html | strip | default: 'Image' }}" />
      {% if first_item.caption %}
      <figcaption>{{ first_item.caption | markdownify }}</figcaption>
      {% endif %}
    </figure>
  {% endif %}
</div>

{% comment %} Interactive carousel - hidden when printing {% endcomment %}
<div class="carousel-wrapper no-print" id="carousel-{{ carousel_id }}" data-pswp-gallery="{{ gallery_id }}">
  
  {% comment %} Carousel viewport {% endcomment %}
  <div class="carousel-viewport">
    <div class="carousel-track" data-carousel-track>
      {% for item in carousel_data.images %}
      <div class="carousel-slide{% if forloop.first %} is-active{% endif %}" 
           data-slide-index="{{ forloop.index0 }}">
        <a href="{{ item.image }}"
           class="carousel-slide-link no-external-link-icon"
           style="outline: none"
           data-pswp-slide
           data-pswp-width="auto"
           data-pswp-height="auto"
           {% if item.caption %}data-pswp-caption="{{ item.caption | markdownify | replace: '<p>', '' | replace: '</p>', '' | xml_escape }}"{% endif %}
           aria-label="View slide {{ forloop.index }} in lightbox{% if item.caption %}: {{ item.caption | strip_html }}{% endif %}">
          
          <div class="carousel-image-container">
            <img src="{{ item.image }}"
                 alt="{{ item.alt | default: item.caption | markdownify | strip_html | strip | default: 'Slide ' | append: forloop.index }}"
                 loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
                 decoding="async"
                 class="carousel-image" />
          </div>
          
          {% if item.caption %}
          <div class="carousel-caption" onclick="event.stopPropagation()">
            {{ item.caption | markdownify }}
          </div>
          {% endif %}
        </a>
      </div>
      {% endfor %}
    </div>
  </div>
  
  {% comment %} Navigation controls {% endcomment %}
  {% if carousel_data.images.size > 1 %}
  <button class="carousel-control carousel-prev" 
          type="button"
          aria-label="Previous slide"
          data-carousel-prev>
    <span class="icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"/>
      </svg>
    </span>
  </button>
  
  <button class="carousel-control carousel-next" 
          type="button"
          aria-label="Next slide"
          data-carousel-next>
    <span class="icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="9 18 15 12 9 6"/>
      </svg>
    </span>
  </button>
  
  {% comment %} Indicators {% endcomment %}
  <div class="carousel-indicators" role="tablist" aria-label="Slide indicators">
    {% for item in carousel_data.images %}
    <button class="carousel-indicator{% if forloop.first %} is-active{% endif %}"
            type="button"
            role="tab"
            aria-label="Go to slide {{ forloop.index }}"
            aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
            data-slide-index="{{ forloop.index0 }}"></button>
    {% endfor %}
  </div>
  {% endif %}
</div>

{% comment %} Carousel JavaScript {% endcomment %}
<script>
(function() {
  'use strict';
  
  const carouselId = '{{ carousel_id }}';
  const carousel = document.getElementById('carousel-' + carouselId);
  
  if (!carousel) return;
  
  const track = carousel.querySelector('[data-carousel-track]');
  const slides = Array.from(carousel.querySelectorAll('.carousel-slide'));
  const prevBtn = carousel.querySelector('[data-carousel-prev]');
  const nextBtn = carousel.querySelector('[data-carousel-next]');
  const indicators = Array.from(carousel.querySelectorAll('.carousel-indicator'));
  
  let currentIndex = 0;
  let isTransitioning = false;
  
  // Set image dimensions for PhotoSwipe
  const links = carousel.querySelectorAll('a[data-pswp-width="auto"]');
  links.forEach(link => {
    const img = link.querySelector('img');
    if (!img) return;
    
    const setDimensions = () => {
      if (img.naturalWidth > 0 && img.naturalHeight > 0) {
        link.setAttribute('data-pswp-width', img.naturalWidth);
        link.setAttribute('data-pswp-height', img.naturalHeight);
        return true;
      }
      return false;
    };
    
    if (img.complete) {
      setDimensions();
    } else {
      img.addEventListener('load', setDimensions, { once: true });
    }
  });
  
  function goToSlide(index, direction = 'next') {
    if (isTransitioning || index === currentIndex) return;
    if (index < 0 || index >= slides.length) return;
    
    isTransitioning = true;
    
    const currentSlide = slides[currentIndex];
    const nextSlide = slides[index];
    
    // Update active states
    currentSlide.classList.remove('is-active');
    nextSlide.classList.add('is-active');
    
    if (indicators.length > 0) {
      indicators[currentIndex].classList.remove('is-active');
      indicators[currentIndex].setAttribute('aria-selected', 'false');
      indicators[index].classList.add('is-active');
      indicators[index].setAttribute('aria-selected', 'true');
    }
    
    // Smooth transition
    const offset = -index * 100;
    track.style.transform = `translateX(${offset}%)`;
    
    currentIndex = index;
    
    setTimeout(() => {
      isTransitioning = false;
    }, 500);
  }
  
  // Navigation controls
  if (prevBtn) {
    prevBtn.addEventListener('click', () => {
      const prevIndex = currentIndex === 0 ? slides.length - 1 : currentIndex - 1;
      goToSlide(prevIndex, 'prev');
    });
  }
  
  if (nextBtn) {
    nextBtn.addEventListener('click', () => {
      const nextIndex = (currentIndex + 1) % slides.length;
      goToSlide(nextIndex, 'next');
    });
  }
  
  // Indicator controls
  indicators.forEach((indicator, index) => {
    indicator.addEventListener('click', () => {
      goToSlide(index);
    });
  });
  
  // Keyboard navigation
  carousel.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') {
      e.preventDefault();
      prevBtn && prevBtn.click();
    } else if (e.key === 'ArrowRight') {
      e.preventDefault();
      nextBtn && nextBtn.click();
    }
  });
  
  // Touch swipe support
  let touchStartX = 0;
  let touchEndX = 0;
  
  track.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
  }, { passive: true });
  
  track.addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  }, { passive: true });
  
  function handleSwipe() {
    const swipeThreshold = 50;
    const diff = touchStartX - touchEndX;
    
    if (Math.abs(diff) > swipeThreshold) {
      if (diff > 0) {
        nextBtn && nextBtn.click();
      } else {
        prevBtn && prevBtn.click();
      }
    }
  }
  
  // Auto-play
  {% assign auto_play = include.auto_play | default: carousel_data.settings.auto_play | default: false %}
  {% assign duration = include.duration | default: carousel_data.settings.duration | default: 5 %}
  
  {% if auto_play %}
  let autoPlayInterval;
  
  function startAutoPlay() {
    autoPlayInterval = setInterval(() => {
      if (document.hidden) return;
      nextBtn && nextBtn.click();
    }, {{ duration }} * 1000);
  }
  
  function stopAutoPlay() {
    clearInterval(autoPlayInterval);
  }
  
  // Start auto-play
  startAutoPlay();
  
  // Pause on hover/focus
  carousel.addEventListener('mouseenter', stopAutoPlay);
  carousel.addEventListener('mouseleave', startAutoPlay);
  carousel.addEventListener('focusin', stopAutoPlay);
  carousel.addEventListener('focusout', startAutoPlay);
  
  // Pause when page hidden
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      stopAutoPlay();
    } else {
      startAutoPlay();
    }
  });
  {% endif %}
})();
</script>
