{%- comment -%}
*
* MIT License
* Copyright (c) 2025 Raghuveer S, Edoardo Tosin
*
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in all
* copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
* SOFTWARE.
*
* File: Related.html
* Author Raghuveer S, Edoardo Tosin
*
* This file contains the markup for the small greyish box that you see at the end
* of all blogposts. It contains the markup to create a small of all the posts
* that are related by tag. The limit I think is restricted to 10.
*
{%- endcomment -%}

<!-- Related posts and notes -->
{%- assign relatedItems = site.posts | concat: site.notes -%}
{%- assign maxRelated = 8 -%}
{%- assign counter = 0 -%}

{%- assign filteredItems = "" | split: "" -%}

{%- for item in relatedItems -%}
  {%- if item.url != page.url and item.tags and page.tags -%}
    {%- assign commonTags = item.tags | where_exp: "tag", "page.tags contains tag" -%}
    {%- if commonTags.size > 0 -%}
      {%- assign filteredItems = filteredItems | push: item -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- if filteredItems.size > 0 and site.preferences.related.enabled -%}
  <div class="related show no-print" id="jekyll-seamless-relatedposts" role="complementary" aria-labelledby="related-heading">
    <h5 class="block-title no-print">Similar Content</h5>
    <div class="related-wrapper no-print" role="navigation" aria-label="Related content navigation">

      {%- for item in filteredItems -%}
        {%- if counter >= maxRelated -%} {%- break -%} {%- endif -%}

        {%- assign rendered_content = item.content | markdownify -%}
        {%- assign excerpt_text = rendered_content
            | strip_html
            | strip
            | replace: "[[", ""
            | replace: "]]", ""
            | escape
            | truncate: 140
        -%}

        <div class="related-group no-print">
          <a class="no-external-link-icon" href="{{ item.url | absolute_url }}" aria-describedby="related-{{ counter }}-excerpt">
            <h6>{{ item.title }}</h6>
            <p class="excerpt" style="margin:0px; color: var(--color-text-main) !important;">
              {{ excerpt_text }}
            </p>
          </a>
        </div>

        {%- assign counter = counter | plus: 1 -%}
      {%- endfor -%}

    </div>
    <br/>
  </div>
{%- endif -%}
