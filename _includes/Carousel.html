{%- comment -%}
*
* MIT License
* Copyright (c) 2024 Edoardo Tosin
*
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in all
* copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
* SOFTWARE.
*
* File: Carousel.html
* Edoardo Tosin
* This file contains the markup for a responsive image carousel with indicators
* and automatic sliding functionality.
*
{%- endcomment -%}

{% comment %}
  Carousel Component with PhotoSwipe Integration
  
  Usage:
    {% include Carousel.html 
      id="my-carousel"
      gallery="my-gallery"
    %}
  
  Front Matter Configuration:
    carousels:
      - id: my-carousel
        images:
          - image: /path/to/image1.jpg
            caption: "First image"
            alt: "Alt text"
          - image: /path/to/image2.jpg
            caption: "Second image"
        settings:
          auto_play: true
          duration: 5
  
  Parameters:
    - id (optional): Carousel ID to match front matter
    - number (optional): Legacy numeric index
    - gallery (optional): Gallery ID for PhotoSwipe grouping
    - auto_play (optional): Override auto-play setting
    - duration (optional): Override duration (seconds)
{% endcomment %}

{% comment %} Select carousel data {% endcomment %}
{% if include.id %}
  {% for carousel in page.carousels %}
    {% if carousel.id == include.id %}
      {% assign carousel_data = carousel %}
      {% assign carousel_index = forloop.index0 %}
      {% break %}
    {% endif %}
  {% endfor %}
{% elsif include.number %}
  {% assign carousel_index = include.number | minus: 1 %}
  {% assign carousel_data = page.carousels[carousel_index] %}
{% else %}
  {% assign carousel_index = 0 %}
  {% assign carousel_data = page.carousels[0] %}
{% endif %}

{% comment %} Generate unique IDs {% endcomment %}
{% if include.id %}
  {% assign carousel_id = include.id | slugify %}
{% else %}
  {% assign carousel_id = carousel_index %}
{% endif %}

{% assign gallery_id = include.gallery | default: carousel_id | append: '-gallery' %}

{% comment %} Error handling {% endcomment %}
{% unless carousel_data %}
  <div class="notification is-danger">
    <strong>Carousel Error:</strong> No carousel data found for 
    {% if include.id %}"{{ include.id }}"{% elsif include.number %}number {{ include.number }}{% else %}default carousel{% endif %}.
  </div>
  {% break %}
{% endunless %}

{% comment %} Auto-play settings {% endcomment %}
{% assign auto_play = include.auto_play | default: carousel_data.settings.auto_play | default: false %}
{% assign duration = include.duration | default: carousel_data.settings.duration | default: 5 %}

{% comment %} Print-only fallback - show first image only {% endcomment %}
<div class="only-print">
  {% assign first_item = carousel_data.images[0] %}
  {% if first_item %}
    <figure class="image">
      <img src="{{ first_item.image }}" 
           alt="{{ first_item.alt | default: first_item.caption | markdownify | strip_html | strip | default: 'Image' }}" />
      {% if first_item.caption %}
      <figcaption>{{ first_item.caption | markdownify }}</figcaption>
      {% endif %}
    </figure>
  {% endif %}
</div>

{% comment %} Interactive carousel - hidden when printing {% endcomment %}
<div class="carousel-wrapper no-print" 
     id="carousel-{{ carousel_id }}" 
     data-pswp-gallery="{{ gallery_id }}"
     data-auto-play="{{ auto_play }}"
     data-duration="{{ duration }}">
  
  {% comment %} Carousel viewport with inline critical styles {% endcomment %}
  <div class="carousel-viewport" style="position: relative; overflow: hidden; width: 100%; padding-bottom: 66.67%;">
    <div class="carousel-track" data-carousel-track style="position: absolute; top: 0; left: 0; display: flex; width: 100%; height: 100%; transform: translateX(0); transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);">
      {% for item in carousel_data.images %}
      <div class="carousel-slide{% if forloop.first %} is-active{% endif %}" 
           data-slide-index="{{ forloop.index0 }}"
           style="flex: 0 0 100%; width: 100%; height: 100%;">
        <a href="{{ item.image }}"
           class="carousel-slide-link no-external-link-icon"
           style="display: block; position: relative; width: 100%; height: 100%; outline: none; cursor: zoom-in;"
           data-pswp-slide
           data-pswp-width="auto"
           data-pswp-height="auto"
           {% if item.caption %}data-pswp-caption="{{ item.caption | markdownify | replace: '<p>', '' | replace: '</p>', '' | xml_escape }}"{% endif %}
           aria-label="View slide {{ forloop.index }} in lightbox{% if item.caption %}: {{ item.caption | strip_html }}{% endif %}">
          
          <div class="carousel-image-container" style="position: relative; width: 100%; height: 100%; background: var(--pswp-bg-primary, hsl(0, 0%, 96%)); display: flex; align-items: center; justify-content: center;">
            <img src="{{ item.image }}"
                 alt="{{ item.alt | default: item.caption | markdownify | strip_html | strip | default: 'Slide ' | append: forloop.index }}"
                 loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
                 decoding="async"
                 class="carousel-image"
                 style="width: 100%; height: auto; display: block; object-fit: contain;" />
          </div>
          
          {% if item.caption %}
          <div class="carousel-caption">
            {{ item.caption | markdownify }}
          </div>
          {% endif %}
        </a>
      </div>
      {% endfor %}
    </div>
  </div>
  
  {% comment %} Navigation controls {% endcomment %}
  {% if carousel_data.images.size > 1 %}
  <button class="carousel-control carousel-prev" 
          type="button"
          aria-label="Previous slide"
          data-carousel-prev>
    <span class="icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"/>
      </svg>
    </span>
  </button>
  
  <button class="carousel-control carousel-next" 
          type="button"
          aria-label="Next slide"
          data-carousel-next>
    <span class="icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="9 18 15 12 9 6"/>
      </svg>
    </span>
  </button>
  
  {% comment %} Indicators {% endcomment %}
  <div class="carousel-indicators" role="tablist" aria-label="Slide indicators">
    {% for item in carousel_data.images %}
    <button class="carousel-indicator{% if forloop.first %} is-active{% endif %}"
            type="button"
            role="tab"
            aria-label="Go to slide {{ forloop.index }}"
            aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
            data-slide-index="{{ forloop.index0 }}"></button>
    {% endfor %}
  </div>
  {% endif %}
</div>

{% comment %} Load carousel JavaScript {% endcomment %}
<script src="{{ site.baseurl }}/assets/js/carousel.js" defer {{ "/assets/js/carousel.js" | sri_attrs }}></script>
