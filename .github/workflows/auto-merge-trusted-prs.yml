name: Auto-merge Obsidian Sync PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge-sync:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.pull_request.labels.*.name, 'obsidian-sync') ||
      (github.actor == github.repository_owner && contains(github.event.pull_request.title, 'sync:'))
    
    steps:
      - name: Wait for CI Checks
        uses: fountainhead/action-wait-for-check@v1.1.0
        id: wait-for-checks
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: "Build and Test Site"
          timeoutSeconds: 600
          intervalSeconds: 10

      - name: Verify PR is Ready
        id: verify
        run: |
          # Check if PR is from sync workflow
          if [[ "${{ github.event.pull_request.user.login }}" == "${{ github.repository_owner }}" ]] && 
             [[ "${{ github.event.pull_request.title }}" == sync:* ]]; then
            echo "ready=true" >> $GITHUB_OUTPUT
          else
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "❌ PR not eligible for auto-merge"
          fi

      - name: Auto-approve and Merge
        if: steps.wait-for-checks.outputs.conclusion == 'success' && steps.verify.outputs.ready == 'true'
        run: |
          # Approve the PR
          gh pr review --approve "${{ github.event.pull_request.html_url }}" \
            --body "✅ Auto-approved: Obsidian sync PR with passing CI checks"
          
          # Enable auto-merge
          gh pr merge --auto --squash "${{ github.event.pull_request.html_url }}" \
            --subject "$(echo "${{ github.event.pull_request.title }}" | head -c 50)" \
            --body "Automatically merged Obsidian sync changes"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on Failure
        if: steps.wait-for-checks.outputs.conclusion == 'failure'
        run: |
          gh pr comment "${{ github.event.pull_request.html_url }}" \
            --body "❌ Auto-merge cancelled: CI checks failed. Please review and fix the issues."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
