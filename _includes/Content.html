{%- comment -%}
*
* MIT License
* Copyright (c) 2020 Raghuveer S, Hiran Venugopalan
*
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in all
* copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
* SOFTWARE.
*
* File: Content.html
* Author Raghuveer S, Hiran Venugopalan
*
* This file contains the markup for the context menu thingy you see when you right
* click on the post titles on the home page.
*
{%- endcomment -%}


<!-- Parse internal links, external links, transclusions etc and manipuate the content to reflect it accordingly -->
<div class="content">
    {%- if site.preferences.wiki_style_link.enabled -%}
        {%- assign content_array = content | split:'[[' -%}
        {%- assign external_link_delimiter = '::' -%}

        {%- assign link_joiner_delimiter = '$@' -%}
        {%- for item in content_array -%}
            {%- if forloop.index > 1 -%}
                {%- assign itemparts = item | split:']]' -%}
                {%- assign internal_link = itemparts[0] -%}
                {%- assign external_link = itemparts[0] | split:external_link_delimiter -%}
                {%- assign sidenote = itemparts[0] | split:sidenote_delimiter -%}
            
                {%- if external_link[1] == nil -%}
                    {%- assign result_posts = site.posts | where: 'title', itemparts[0] -%}
                    {%- assign result_notes = site.notes | where: 'title', itemparts[0] -%}
                    {%- assign result_pages = site.pages | where: 'title', itemparts[0] -%}

                    {%- if result_posts.size == 0 and result_notes.size == 0 -%}
                        {%- assign post_by_filename = site.posts | where_exp: "post", "post.path contains itemparts[0] | slugify" -%}
                        {%- assign note_by_filename = site.notes | where_exp: "note", "note.path contains itemparts[0] | slugify" -%}
                        {%- assign result_posts = post_by_filename.size > 0 ? post_by_filename : result_posts -%}
                        {%- assign result_notes = note_by_filename.size > 0 ? note_by_filename : result_notes -%}
                    {%- endif -%}

                    {%- if result_posts.size > 0 -%}
                        {%- assign post_url = result_posts[0].url -%}
                    {%- elsif result_notes.size > 0 -%}
                        {%- assign post_url = result_notes[0].url -%}
                    {%- elsif result_pages.size > 0 -%}
                        {%- assign post_url = result_pages[0].url -%}
                    {%- else -%}
                        {%- assign post_url = nil -%}
                    {%- endif -%}

                    {%- assign internal_links = internal_links | append: link_joiner_delimiter | append: internal_link -%}
                    {%- assign internal_urls = internal_urls | append: link_joiner_delimiter | append: post_url -%}
                {%- else -%}
                    {%- assign external_links = external_links | append: link_joiner_delimiter | append: external_link[0] -%}
                    {%- assign external_urls = external_urls | append: link_joiner_delimiter | append: external_link[1] -%}
                {%- endif -%}
            {%- endif -%}
        {%- endfor -%}
    
        {%- assign internal_url_array = internal_urls | split:link_joiner_delimiter -%}
        {%- assign internal_link_array = internal_links | split:link_joiner_delimiter -%}

        {%- assign external_url_array = external_urls | split:link_joiner_delimiter -%}
        {%- assign external_link_array = external_links | split:link_joiner_delimiter -%}

    
        {%- assign replaced_content = content -%}
        {%- for title in internal_link_array -%}
            {%- assign url = internal_url_array[forloop.index0] -%}
            {%- if url == nil -%}
                {%- assign link_text = '<span class="tooltip"><a class="stale-link" href="' | append: 'javascript:void(0)' | append: '">' | append: title | append: '</a> <span class="right bottom"> <span class="tooltip-title">' | append: {{site.privatelinks.title}} | append: '</span><br/><span class="tooltip-excerpt">' | append: {{site.privatelinks.msg}} | append : ' <br/></span> </span></span>' -%}
            {%- elsif url == empty -%}
                {%- assign link_text = '<span class="tooltip"><a class="stale-link" href="' | append: 'javascript:void(0)' | append: '">' | append: title | append: '</a> <span class="right bottom"> <span class="tooltip-title">' | append: {{site.privatelinks.title}} | append: '</span><br/><span class="tooltip-excerpt">' | append: {{site.privatelinks.msg}} | append : ' <br/></span> </span></span>' -%}
            {%- else -%}
                    {%- assign post = site.notes | where: 'title',title -%}
                    {%- if post[0].title == nil -%}
                    {%- assign post = site.posts | where: 'title',title -%}
                    {%- endif -%}
                    {%- assign excerpt = post[0].content | markdownify | strip_html | truncate: 200 | newline_to_br -%}
                    {%- if site.preferences.pagepreview.enabled -%}
                        {%- assign link_text = '<span class="tooltip"><a href="' |append: {{site.baseurl}} | append: url | append: '">' | append: title | append: '</a><span class="right bottom"><span class="tooltip-title">' | append: title | append: '</span><br/><span class="tooltip-excerpt">' | append: excerpt | remove: "[[" | remove: "]]" | append: '</span><i></i></span></span>' -%}
                    {%- else -%}
                        {%- assign link_text = '<span><a href="' | append: url | append: '">' | append: title | append: '</a></span>' -%}
                    {%- endif -%}
            {%- endif -%}
            {%- assign bracket_link = '[[' | append: title | append: ']]' -%}
            {%- assign replaced_content = replaced_content | replace: bracket_link,link_text -%}
        {%- endfor -%}

        {%- assign sideNoteCounter = 0 -%}
        {%- assign srsCounter = 0 -%}
        {%- for title in external_link_array -%}
            {%- assign url = external_url_array[forloop.index0] -%}
            {%- if url == "highlight" -%}
                {%- if site.preferences.highlighting.enabled -%}
                    {%- assign color = '#DAEDFF' -%}
                    {%- if site.preferences.highlighting.color != nil and site.preferences.highlighting.color != empty and
                        site.preferences.highlighting.color != null -%}
                        {%- assign color = '#' | append: site.preferences.highlighting.color -%}
                    {%- endif -%}
                    {%- assign link_text = '<span style="font-family: inherit; font-weight: inherit; font-style: inherit; font-size: inherit; background-color:' | append: color | append: ';">' | append: title | append: '</span>' -%}
                {%- endif -%}
            {%- elsif url == "wrap" -%}
                {%- if site.preferences.wrapping.enabled -%}
                    {%- assign link_text = '<p class="boxit">' | append: title | append: '</p>' -%}
                {%- endif -%}
            {%- elsif url == "img" -%}
                {%- if site.preferences.wrapping.enabled -%}
                    {%- assign link_text = '<img src="' | append: title | append: '"/>' -%}
                {%- endif -%}
            {%- elsif url == "lsn" or url == "rsn" or url == "lsn-transclude" or url == "rsn-transclude"  or url == "lmn" or url == "rmn" or url == "lmn-transclude" or url == "rmn-transclude" -%}
                {%- assign toggleLabel = "" -%}
                {%- assign sideNoteNum = "" -%}
                {%- if url contains "lsn" -%}
                    {%- assign noteType = "sn-left" -%}
                    {%- assign sideNoteNum = "sidenote-number" -%}
                {%- elsif url contains "rsn" -%}
                    {%- assign noteType = "sn-right" -%}
                    {%- assign sideNoteNum = "sidenote-number" -%}
                {%- elsif url contains "lmn" -%}
                    {%- assign noteType = "mn-left" -%}
                    {%- assign toggleLabel = "&#8853;" -%}
                {%- elsif url contains "rmn" -%}
                    {%- assign noteType = "mn-right" -%}
                    {%- assign toggleLabel = "&#8853;" -%}
                {%- endif -%}


                {%- if url contains "transclude" -%}
                    {%- if site.preferences.sidenotes.enabled -%}
                        {%- assign post = site.posts | where: 'title',title -%}
                        {%- assign excerpt = post[0].content | strip_html | truncate: 280 -%}
                        {%- assign link_text = '<label for="' | append: url | append: '-' | append: sideNoteCounter | append: '" class="margin-toggle ' | append: sideNoteNum | append: ' ">' | append: toggleLabel | append: '</label><input type="checkbox" id="' | append: url | append: '-' | append: sideNoteCounter | append: '" class="margin-toggle"/><span class="' | append: noteType | append: '"><a href="' | append: post[0].url  | append: '"> <span style="background-color: #ffffc4; color: #555;">Transclusion</span><br/><b>' | append: title | append: '</b><br/>' | append: excerpt | append: '</a></span>' -%}
                    {%- endif -%}
                {%- else -%}
                    {%- if site.preferences.sidenotes.enabled -%}
                        {%- assign link_text = '<label for="' | append: url | append: '-' | append: sideNoteCounter | append: '" class="margin-toggle ' | append: sideNoteNum | append: ' ">' | append: toggleLabel | append: '</label><input type="checkbox" id="' | append: url | append: '-' | append: sideNoteCounter | append: '" class="margin-toggle"/><span class="' | append: noteType | append: '">' | append: title | append: '</span>' -%}
                    {%- endif -%}
                {%- endif -%}

                {%- assign sideNoteCounter = sideNoteCounter | plus:1 -%}
            {%- elsif url == "srs" -%}
                {%- if site.preferences.flashcards.enabled -%}
                    {%- assign link_text = '<label for="' | append: url | append: '-' | append: srsCounter | append: '" class="srs-toggle "><svg class="srs-svg" height="20" width="18" viewBox="0 0 100 125" xml:space="preserve"><path fill="none" d="M41.648 12.407a1 1 0 0 0-1.383-.295l-5.235 3.396 8.239-.602zM28.45 19.776 8.471 32.737c-.462.3-.594.921-.294 1.384l23.832 36.736-3.638-49.85a5 5 0 0 1 .079-1.231"/><path d="m40.055 81.425.127-.082-1.181.086c.318.186.73.206 1.054-.004"/><path d="M94.964 32.733a4.97 4.97 0 0 0-2.93-2.462l-15.315-4.845-.576-7.905c-.2-2.721-2.604-4.834-5.352-4.623l-22.969 1.676-2.818-4.344a4.98 4.98 0 0 0-4.197-2.28c-.966 0-1.907.279-2.719.806L6.294 29.381a5.005 5.005 0 0 0-1.473 6.916l30.496 47.008a4.98 4.98 0 0 0 4.198 2.28c.965 0 1.905-.278 2.717-.806l1.04-.675 28.847 9.123c.491.155.999.233 1.511.233a4.98 4.98 0 0 0 4.764-3.491l16.902-53.424a4.97 4.97 0 0 0-.332-3.812M40.266 12.112a.996.996 0 0 1 1.383.295l1.622 2.5-8.239.602zM8.177 34.121a1.003 1.003 0 0 1 .294-1.384l19.979-12.96a5 5 0 0 0-.08 1.23l3.638 49.85zm27.501 32.07L32.36 20.716c-.04-.55.375-1.031.924-1.071l12.471-.909 4.552-.332 20.852-1.52c.519 0 .955.408.993.928l.461 6.315L55.9 18.841a4.97 4.97 0 0 0-4.703.935 5 5 0 0 0-1.571 2.324l-.554 1.75zM91.48 35.34 80.072 71.4l-2.057 6.5-3.438 10.867c-.194.614-.798.794-1.253.647l-25.706-8.13-1.247-.394-3.694-1.169-5.488-1.735a1 1 0 0 1-.586-.493 1 1 0 0 1-.093-.617c.007-.047.011-.093.026-.143L51.89 28.197l1.547-4.891c.005-.016.016-.026.021-.041a1 1 0 0 1 1.233-.612l18.233 5.768 4.105 1.299 13.795 4.364a1 1 0 0 1 .588.494.98.98 0 0 1 .068.762"/><path d="M40.055 81.425c-.323.21-.735.19-1.054.004l1.181-.086z"/></svg></label><input type="checkbox" id="' | append: url | append: '-' | append: srsCounter | append: '" class="srs-toggle"/><span class="spaced-rep"><span style="font-size: 16px; color: #555;"><u><strong>Flashcard</strong></u></span><br/>' | append: title | append: '</span>' -%}
                    {%- assign srsCounter = srsCounter | plus:1 -%}
                {%- endif -%}
            {%- else -%}
                {%- assign link_text = '<a href="' | append: url | append: '">' | append: title | append: '</a>' -%}
            {%- endif -%}
            {%- assign bracket_link = '[[' | append: title | append: external_link_delimiter | append: url | append: ']]' -%}
            {%- assign replaced_content = replaced_content | replace: bracket_link,link_text -%}
        {%- endfor -%}

        {{ replaced_content }}
    {%- else -%}
        {{content}}
    {%- endif -%}
</div>